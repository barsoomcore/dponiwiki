{% extends "templates/base.html" %}
{% load smart_if %}
{% load humanize %}
{% block title %}
	{% if villain_level != '0' %}{{ villain_level|ordinal }} Level {% endif %}
	{% if villain_name %}{{ villain_name }}
	{% else %}Villain Generator{% endif %}
{% endblock %}
{% block head %}
<script type="text/javascript">
	function villain(selected_level, URL, name){
		this.Level = selected_level[0];
		this.BCB = selected_level[1];
		this.SCB = selected_level[2];
		this.Fortitude = parseInt(selected_level[3]) + parseInt(selected_level[12]);
		this.Reflex = parseInt(selected_level[4]) + parseInt(selected_level[11]);
		this.Will = parseInt(selected_level[5]) + parseInt(selected_level[14]);
		this.DC = selected_level[7];
		this.Damage = selected_level[8];
		this.Base_Toughness = selected_level[9];
		this.Strength = selected_level[10];
		this.Dexterity = selected_level[11];
		this.Constitution = selected_level[12];
		this.Intelligence =selected_level[13];
		this.Wisdom = selected_level[14];
		this.Charisma = selected_level[15];
		this.URL = URL + '/' + this.Level;
		
		this.MB = parseInt(this.BCB) + parseInt(this.Strength);
		this.Primary_Attack = parseInt(this.BCB) + parseInt(this.Dexterity);
		this.Full_Damage = parseInt(this.Damage) + parseInt(this.Strength);
		this.Base_Defense = parseInt(this.BCB) + 10;
		this.Dodge = this.Base_Defense + parseInt(this.Dexterity);
		this.Parry = this.Base_Defense + parseInt(this.Strength);
		
		this.Secondary_Attack = parseInt(this.SCB) + parseInt(this.Dexterity);
		this.Second_Defense = parseInt(this.SCB) + 10;
		this.Second_Dodge = this.Second_Defense + parseInt(this.Dexterity);
		this.Second_Parry = this.Second_Defense + parseInt(this.Strength);
		
		this.set_Reputation = function(){
			var Reputation = ((parseInt(this.Level)/5)).toPrecision(1);
			if (Reputation < 1) { Reputation = 0 };
			if ('{{ villain_name }}' == 'War Leader'){
				Reputation = parseInt(Reputation) + 3;
			}
			this.Reputation = Reputation;
		};
		this.set_Toughness = function(){
			var Toughness = '';
			if (this.Base_Toughness){
				Toughness = parseInt(this.Base_Toughness) + parseInt(this.Constitution);
			}
			else Toughness = parseInt(this.Constitution);
			
			this.Toughness = Toughness;
		};
		
		this.format_attributes = function(){
			var Attributes = [this.Strength, this.Dexterity, this.Constitution, this.Intelligence, this.Wisdom, this.Charisma];
			var Attribute_names = ['Strength', 'Dexterity', 'Constitution', 'Intelligence', 'Wisdom', 'Charisma'];
		
			for(var i = 0; i < Attributes.length; i++){
				if ( Attributes[i].charAt(0) != '-'){
					this[Attribute_names[i]] = '+' + Attributes[i];
				}
			}
		};
		
		this.create_skills_list = function(skills){
			var skill_list = new Array();
			for (var i = 0; i < skills.length; i++) {
				var key_ability = skills[i][1];
				var this_skill = new Array();
				this_skill[0] = skills[i][0];
				this_skill[1] = 3 + parseInt(this.Level) + parseInt(this[key_ability]);
				if ('{{ villain_name }}' == 'Artillery') {
					var Level_Skills = ['Acrobatics', 'Climb', 'Jump', 'Swim'];
					for (var j = 0; j <= Level_Skills.length; j++) {
						if (this_skill[0] == Level_Skills[j]) {
							this_skill[1] = this_skill[1] - 3;
						}
					}
				}
				if ('{{ villain_name }}' == 'War Leader') {
					if (this_skill[0] == 'Notice') {
						this_skill[1] = this_skill[1] - 3;
					}
				}
				if (String(this_skill[1]).charAt(0) != '-')
					this_skill[1] = '+' + this_skill[1];
				skill_list.push(this_skill.join(':&nbsp;'));
			}
			this.Skills = skill_list.join('; ');
		};
		
		this.create_abilities_list = function(villain_data){
			var total_abilities = new Array();
			var j = 0;
			for (var i = 1; i <= this.Level; i++) {
				if (villain_data[i][6] != ''){
					total_abilities[j] = villain_data[i][6];
					j++;
				}
			}	
			this.Abilities = total_abilities.join(', ');
		};
		
		// got this function from the good folks at Shopify
		// http://forums.shopify.com/categories/2/posts/29259
		this.set_Level = function() {
			var n = this.Level;
			var s=["th","st","nd","rd"],
			   v=n%100;
			this.Level = n+(s[(v-20)%10]||s[v]||s[0]);
		};
		
		this.display = function(){
			$(".StatBlock").show();
			$(".Level").html(this.Level + ' Level ');
			$(".BCB").html(this.BCB);
			$(".Primary_Attack").html(this.Primary_Attack);
			$(".Secondary_Attack").html(this.Secondary_Attack);
			$(".Fort").html(this.Fortitude);
			$(".Ref").html(this.Reflex);
			$(".Will").html(this.Will);
			if (this.Abilities != '') {$(".Abilities").html(this.Abilities);}
				else $(".Abilites").html('None');
			if (this.DC != '') {$(".DC").html(this.DC);}
				else $(".DC").hide();
			$(".Damage").html(this.Damage);
			$(".Toughness").html(this.Toughness);
			$(".Strength").html(this.Strength);
			$(".Dexterity").html(this.Dexterity);
			$(".Constitution").html(this.Constitution);
			$(".Intelligence").html(this.Intelligence);
			$(".Wisdom").html(this.Wisdom);
			$(".Charisma").html(this.Charisma);
			$(".MB").html(this.MB);
			$(".Full_Damage").html(this.Full_Damage);
			$(".FF").html(this.Base_Defense);
			$(".Dodge").html(this.Dodge);
			$(".Parry").html(this.Parry);
			if (this.SCB) {
				$(".Second_Defense").html(' (' + this.Second_Defense + ')');
				$(".Second_Dodge").html(' (' + this.Second_Dodge + ')');
				$(".Second_Parry").html(' (' + this.Second_Parry + ')');
			}
			$(".Skills").html(this.Skills);
			$(".Reputation").html(this.Reputation);
			$(".villain_link").attr('href',this.URL);
			$(".villain_link").show();
			$("title").html(this.Level + ' Level ' + name);
		};
	};
	
	function create_villain(select, villain_data, skills, URL, name){
		var new_villain = new villain(villain_data[select], URL, name);
		new_villain.format_attributes();
		new_villain.create_abilities_list(villain_data);
		new_villain.create_skills_list(skills);
		new_villain.set_Toughness();
		new_villain.set_Reputation();
		new_villain.set_Level();
		
		return new_villain;
	};

	
	$(document).ready(function(){
		var villain_data = {{ villain_data|safe }};
		var skills = {{ villain_skills|safe }};
		var selected = {{ villain_level }};
		var URL = '{{ villain_url }}';
		var name = '{{ villain_name }}';
		
		//set the level select options if we're displaying a villain
		if (URL != ''){
			document.Villain.Villain_Level.options.length = 0;
			for (i = 1; i < villain_data.length; i++){
				document.Villain.Villain_Level.options[i] = new Option(i, i);
			}
		}
		
		// if a level has been indicated in the URL, display the villain
		if (selected != '0') {
			var villain_obj = create_villain(selected, villain_data, skills, URL, name);			
			villain_obj.display();
		}
		
		$("#level").change(function(){
			var select = document.Villain.Villain_Level.options.selectedIndex;
			if (select != 0){
				var villain_obj = create_villain(select, villain_data, skills, URL, name);				
				villain_obj.display();
				
			}		
		});
		
	});
	
</script>

{% endblock%}
{% block content %}

	{% if villain_name %}
		<div class="noprint">
		<h4 style="float:left; padding-right: 1em">Select {{ villain_name }} Level:</h4>
		<form name="Villain" style="padding-top: 1.8em;">
			<select name="Villain_Level" id="level">
			</select>
		</form>
		</div>
	{% else %}
		<h1>Selecting A Villain</h1>
		<p>Villains are of course key to any great DINO-PIRATES OF NINJA ISLAND adventure. While you could peruse <a href="/Creatures.php">the list of creatures provided</a>, and select a villain from within, sometimes that's more work than one really needs to take on. Often a villain doesn't need to have every detail specified -- just enough so that you can run a big combat scene. And while window dressing may vary, to be honest, most villains fall into one of a few distinct categories.</p>
		<p>Enter this, the official DINO-PIRATES OF NINJA ISLAND Villain Picker. Start by selecting any of the villain types below, then choose a level appropriate to your party, and you'll have a statblock your party will fear and love, all at the same time.</p>
		<h2>Villain Types</h2>
		<h3><a href="{% url villain_picker 'Artillery' %}">Artillery</a></h3>
		<p>Artillery is meant to present powerful ranged combatants. Unlike lurkers, artillery don’t focus on ambush; they’re good enough, and use terrain intelligently enough, that they can confront things head-on. Unlike skirmishers, artillery don’t have to stay on the move, although clever movement is important to their success and survival.</p>
		<p>This role can represent master archers, range-focused highwaymen, powerful evokers, demon-fused wizards, or any other character that is a threat due to powerful, unending ranged attacks.</p>
		<h3><a href="{% url villain_picker 'Brute' %}">Brute</a></h3>
		<p>Physically powerful and very dangerous, the brute excels at close combat. Whether a demon or beast tearing apart prey, or a mighty warrior crushing weaker foes, the brute closes with and destroys his enemies through sheer power.</p>
		<h3><a href="{% url villain_picker 'Controller' %}">Controller</a></h3>
		<p>Controllers manipulate the battlefield, changing the circumstances to those most beneficial to their cause. Creating barriers, deploying traps and snares, causing deceptions and distractions, and generally wreaking havoc upon movement and coordination is the controller’s specialty. Sometimes, you want a “controller” that enhances his allies rather than altering the field; for such characters look to the War Leader role.</p>
		<p>This role can represent abjurers, conjurers, illutionists, transmuters, and even enchanters. It can also represent specialized grenades, trick arrows, sonic emitter cannons, or any of a dozen other methods for deploying discontent and confusion across a battlefield.</p>
		<h3><a href="{% url villain_picker 'Lurker' %}">Lurker</a></h3>
		<p>The lurker specializes in taking down opponents by underhanded means, and when the prey least expects it. Lurkers are at a disadvantage in a fair fight, but their skills at stealth and deception ensure it should be difficult to pin them down.</p>
		<p>This role is good for stealthy ninjae, singular assassins, cave-dwelling sudden death, or other foes that strike suddenly and unexpectedly, relying upon surprise and precision to defeat powerful foes. Lurkers generally fall quickly if unable to escape to strike again.</p>
		<h3><a href="{% url villain_picker 'Skirmisher' %}">Skirmisher</a></h3>
		<p>The skirmisher is the proof of the power of mobility. Skirmishers not only refuse to stay still, they lose out greatly by not moving. Skirmishers are generally wary of large groups of opponents, due to the risk of being hemmed in and unable to move fast enough. 																	</p>
		<p>This role is ideal for many animalistic predators (cheetah, eagles, and others that rely upon speed), dervish nomads, shadow-dancing rogues, hit-and-run drakes, and classic swinging-from-the-rigging swashbucklers. If the opponent moves fast, and uses that momentum to strike hard, then the skirmisher role is the one you want.</p>
		<h3><a href="{% url villain_picker 'WarLeader' %}">War Leader</a></h3>
		<p>The war leader is a field commander, a leader of troops and a commanding presence on any battlefield. Some inspire their followers through praise and leadership while others use threats and fear. The most dangerous tend to be honorable and noble, but the numbers they can bring and their dedication to dominance make them implacable foes and dangerous politicians.</p><p>Don’t confuse a war leader with a villain that simply attracts followers. Though of moderate power on his own, a war leader uses his followers to even the odds against the party. Other villains may use thugs and footsoldiers but the war leader depends upon them.</p>
		<h2>Where This Came From</h2>
		<p>The idea and execution of Villain Roles was the brainchild of the very clever folks over on <a href="http://true20.com/forum/viewtopic.php?f=2&t=2304">the True20 discussion forums</a>, in particular folks such as The Shadow, iwatt, Baduin and ValhallaGH (who did most of the heavy lifting as far as defining the roles themselves). I just wrote a bit of JavaScript around their hard work.</p>
	{% endif %}
	
	<div class="StatBlock" style="display:none; clear:left" >
		
		<table id="statblocktable">
		<tr>
			<td>Name:</td>
			<td colspan="4"></td>
			<td colspan="4">(<span class="Level"></span>{{ villain_name }} )</td>
			<td colspan="2" class="stat_name">Reputation:</td>
			<td class="statvalue">+<span class="Reputation"></span></td>
		</tr>
		<tr class="titlebar"><td colspan="12">Abilities</td></tr>
		<tr>
			<td width="8%" class="stat_name" style="text-align:center">STR</td><td width="9%" class="statvalue"><span class="Strength"></span></td>
			<td width="8%" class="stat_name" style="text-align:center">DEX</td><td width="9%" class="statvalue"><span class="Dexterity"></span></td>
			<td width="8%" class="stat_name" style="text-align:center">CON</td><td width="9%" class="statvalue"><span class="Constitution"></span></td>
			<td width="8%" class="stat_name" style="text-align:center">INT</td><td width="9%" class="statvalue"><span class="Intelligence"></span></td>
			<td width="8%" class="stat_name" style="text-align:center">WIS</td><td width="8%" class="statvalue"><span class="Wisdom"></span></td>
			<td width="8%" class="stat_name" style="text-align:center">CHA</td><td width="8%" class="statvalue"><span class="Charisma"></span></td>
		</tr>
		
		<tr class="titlebar"><td colspan="12">Skills</td></tr>
		<tr>
			<td colspan="12" style="padding-bottom: 30px"><span class="Skills"></span></td>
		</tr>
		
		<tr class="titlebar"><td colspan="12">Feats and Powers</td></tr>
		<tr>
			<td colspan="12" style="padding-bottom: 30px"><span class="Abilities">None</span></td>
		</tr>
		
		{% if villain_data.1.7 %}
			<tr>
				<td colspan="2">Save DC:</td>
				<td colspan="10"><span class="DC"></span></td>
			</tr>
		{% endif %}
		
		<tr class="titlebar"><td colspan="12">Combat</td></tr>
		<tr>
			<td class="stat_name">Init:</td>
			<td colspan="2" class="statvalue"><span class="Dexterity"></span></td>
			<td colspan="3" class="stat_name">Primary Attack:</td>
			<td colspan="2" class="statvalue">+<span class="Primary_Attack"></span></td>
			<td class="stat_name" colspan="2">Damage:</td>
			<td colspan="2" class="statvalue">+<span class="Full_Damage"></span></td>
		</tr>
		
		<tr><td class="stat_name">Maneuver:</td>
		<td colspan="2" class="statvalue">+<span class="MB"></span></td>
			{% if villain_name = 'Artillery' or villain_name = 'Skirmisher' %}
				<td colspan="3" class="stat_name">Secondary Attack:</td>
				<td colspan="2" class="statvalue">+<span class="Secondary_Attack"></span></td>			
				<td class="stat_name" colspan="2">Damage:</td>
				<td colspan="2" class="statvalue">+<span class="Damage"></span></td>
			{% else %}
				<td colspan="9"></td>
			{% endif %}
		</tr>
		<tr>
			<td colspan="2" class="stat_name" style="font-style:italic; text-align:center">Defense</td>
			<td class="stat_name" colspan="2">Flat-Footed:</td>
			<td colspan="2" class="statvalue"><span class="FF"></span>
				<span class="Second_Defense"></span></td>
			<td class="stat_name">Dodge:</td>
			<td colspan="2" class="statvalue"><span class="Dodge"></span>
				<span class="Second_Dodge"></span></td>
			<td class="stat_name">Parry:</td>
			<td colspan="2" class="statvalue"><span class="Parry"></span>
				<span class="Second_Parry"></span></td>
		</tr>
		<tr class="stat_name" style="text-align:center; background-color: grey; color:white">
			<td>Damage:</td>
			<td colspan="2">0</td>
			<td colspan="3">5+</td>
			<td colspan="3">10+</td>
			<td colspan="3">15+</td>
		</tr>
		<tr class="stat_name" style="text-align:center">
			<td>/</td>
			<td colspan="2">Bruised</td>
			<td colspan="3">Dazed</td>
			<td colspan="3">Staggered</td>
			<td colspan="3">Unconscious</td>
		</tr>
		<tr style="text-align:center;">
			<td>&nbsp;</td>
			<td colspan="2">
				<table width="100%"><tr>
					<td class="checkbox">&nbsp;</td>
					<td>&nbsp;</td>
					<td class="checkbox">&nbsp;</td>
					<td>&nbsp;</td>
					<td class="checkbox">&nbsp;</td>
				</tr></table>
			</td>
			<td colspan="3">
				<table width="100%"><tr>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td class="checkbox">&nbsp;</td>
					<td>&nbsp;</td>
					<td class="checkbox">&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
				</tr></table>
			</td>
			<td colspan="3">
				<table width="100%"><tr>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td class="checkbox">&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
				</tr></table>
			</td>
			<td colspan="3">
				<table width="100%"><tr>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td class="checkbox">&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
				</tr></table>
			</td>
		</tr>
		<tr class="stat_name" style="text-align:center">
			<td>X</td>
			<td colspan="2">Hurt</td>
			<td colspan="3">Wounded</td>
			<td colspan="3">Disabled</td>
			<td colspan="3">Dying</td>
		</tr>
		<tr class="stat_name" style="text-align:center; background-color: grey; color:white"><td>Fatigue:</td><td colspan="11"></td></tr>
		<tr class="stat_name" style="text-align:center">
			<td></td>
			<td colspan="2">Strained</td>
			<td colspan="3">Winded</td>
			<td colspan="3">Fatigued</td>
			<td colspan="3">Exhausted</td>
		</tr>
		<tr style="text-align:center">
			<td>/</td>
			<td colspan="2">
				<table width="100%"><tr>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td class="checkbox">&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
				</tr></table>
			</td>
			<td colspan="3">
				<table width="100%"><tr>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td class="checkbox">&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
				</tr></table>
			</td>
			<td colspan="3">
				<table width="100%"><tr>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td class="checkbox">&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
				</tr></table>
			</td>
			<td colspan="3">
				<table width="100%"><tr>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td class="checkbox">&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
				</tr></table>
			</td>
		</tr>
			
		<tr class="titlebar"><td colspan="12">Saves</td></tr>
		<tr>
			<td colspan="2" class="stat_name">Toughness:</td>
			<td class="statvalue">+<span class="Toughness"></span></td>
			<td colspan="2" class="stat_name">Fortitude:</td>
			<td class="statvalue">+<span class="Fort"></span></td>
			<td colspan="2" class="stat_name">Reflex:</td>
			<td class="statvalue">+<span class="Ref"></span></td>
			<td colspan="2" class="stat_name">Will:</td>
			<td class="statvalue">+<span class="Will"></span></td>
		</tr>
		</table>
	</div>
	
	<p><a class="villain_link noprint" style="display:none" href="{% url villain_picker villain villain_level %}">Permanent link to this villain</a></p>
	
	{% if villain_name %}
		<div style="clear:left" class="noprint">
			<h3>About {{ villain_name }}{% if villain_name != "Artillery" %}s{% endif %}</h3>
			{{ villain_data.1.17|safe }}
		</div>
	{% endif %}
	
	<div id="villain_selection" style="clear:left" class="noprint">
		<h2>Select a{% if villain_name %}nother{% endif %} Villain type:</h2>
		<p><a href="{% url villain_picker 'Artillery' %}">Artillery</a> ::
		 <a href="{% url villain_picker 'Brute' %}">Brute</a> ::
		 <a href="{% url villain_picker 'Controller' %}">Controller</a> ::
		 <a href="{% url villain_picker 'Lurker' %}">Lurker</a> ::
		 <a href="{% url villain_picker 'Skirmisher' %}">Skirmisher</a> ::
		 <a href="{% url villain_picker 'WarLeader' %}">War Leader</a></p>
	{% if latest_updates %}
	<div id="updates" class="noprint">
		<h2>Some Recent Updates</h2>
		
		
			<ul id="island-list">
				{% for island in latest_updates %}
					<li class="{% cycle 'tbeven' 'tbodd' %}"><a href="{{ island.get_absolute_url }}">{{ island.name }}</a>: {{ island.latest_changeset.comment }} ({{ island.latest_changeset.modified|timesince }} ago)</li>
				{% endfor %}
			</ul>
	</div>
	{% endif %}
	
{% endblock %}